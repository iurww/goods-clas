# å•†å“åˆ†ç±» (Goods Classification)

åŸºäº SigLIP å¤šæ¨¡æ€æ¨¡å‹ï¼ˆå›¾åƒ+æ–‡æœ¬ï¼‰çš„å•†å“åˆ†ç±»é¡¹ç›®ï¼Œä½¿ç”¨ PyTorch å®ç°ã€‚



## ğŸ“‹ é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®ä½¿ç”¨ Google çš„ SigLIP (Sigmoid Loss for Language-Image Pre-training) æ¨¡å‹è¿›è¡Œå•†å“åˆ†ç±»ä»»åŠ¡ã€‚æ¨¡å‹åŒæ—¶åˆ©ç”¨å•†å“å›¾åƒå’Œæ–‡æœ¬æè¿°ï¼ˆæ ‡é¢˜+æè¿°ï¼‰è¿›è¡Œå¤šæ¨¡æ€ç‰¹å¾èåˆï¼Œå®ç°æ›´å‡†ç¡®çš„åˆ†ç±»æ•ˆæœã€‚

### ä¸»è¦ç‰¹æ€§

- ğŸ–¼ï¸ **å¤šæ¨¡æ€èåˆ**ï¼šç»“åˆå›¾åƒå’Œæ–‡æœ¬ä¿¡æ¯è¿›è¡Œåˆ†ç±»
- ğŸ”„ **KæŠ˜äº¤å‰éªŒè¯**ï¼šæ”¯æŒåˆ†å±‚KæŠ˜äº¤å‰éªŒè¯ï¼Œæé«˜æ¨¡å‹æ³›åŒ–èƒ½åŠ›
- ğŸ“Š **å®éªŒè·Ÿè¸ª**ï¼šé›†æˆ Weights & Biases (wandb) è¿›è¡Œå®éªŒç®¡ç†
- ğŸ¯ **æ¨¡å‹é›†æˆ**ï¼šè‡ªåŠ¨é›†æˆæ‰€æœ‰æŠ˜çš„æ¨¡å‹è¿›è¡Œé¢„æµ‹
- ğŸ”§ **çµæ´»é…ç½®**ï¼šæ”¯æŒå‘½ä»¤è¡Œå‚æ•°è¦†ç›–é…ç½®



## ğŸ› ï¸ ç¯å¢ƒè¦æ±‚

- Python == 3.13
- uv



## ğŸ“¦ ç¯å¢ƒå®‰è£…

### 1. å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/iurww/goods-clas.git
cd goods-clas
```

### 2. å®‰è£…ä¾èµ–

æœ¬é¡¹ç›®ä½¿ç”¨ `uv` ä½œä¸ºåŒ…ç®¡ç†å™¨ã€‚é¦–å…ˆç¡®ä¿å·²å®‰è£… `uv`ï¼š

```bash
# å®‰è£… uvï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
curl -LsSf https://astral.sh/uv/install.sh | sh
```

ç„¶åå®‰è£…é¡¹ç›®ä¾èµ–ï¼š

```bash
# ä½¿ç”¨ uv å®‰è£…ä¾èµ–
uv sync

# æˆ–è€…ä½¿ç”¨ pipï¼ˆå¦‚æœæœªä½¿ç”¨ uvï¼‰
pip install -e .
```

### 3. é…ç½® Weights & Biasesï¼ˆå¯é€‰ä½†æ¨èï¼‰

```bash
# ç™»å½• wandb
wandb login
```



## ğŸ“¥ æ•°æ®å‡†å¤‡

[æ¯”èµ›åœ°å€](https://www.kaggle.com/competitions/goods-classification/overview)ï¼Œå°†è®­ç»ƒå’Œæµ‹è¯•æ•°æ®ä¸‹è½½åˆ°é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `data/` æ–‡ä»¶å¤¹ã€‚

```
data/
â”œâ”€â”€ train.csv              # è®­ç»ƒé›†æ ‡æ³¨æ–‡ä»¶
â”œâ”€â”€ test.csv               # æµ‹è¯•é›†æ–‡ä»¶
â”œâ”€â”€ train_images/
â”‚   â””â”€â”€ train_images/      # è®­ç»ƒé›†å›¾åƒæ–‡ä»¶å¤¹
â”‚       â”œâ”€â”€ 097585562X.jpg
â”‚       â””â”€â”€ ...
â””â”€â”€ test_images/
    â””â”€â”€ test_images/       # æµ‹è¯•é›†å›¾åƒæ–‡ä»¶å¤¹
        â”œâ”€â”€ 097965856X.jpg
        â””â”€â”€ ...
```

**æ•°æ®æ ¼å¼è¯´æ˜ï¼š**

- `train.csv` åº”åŒ…å«ä»¥ä¸‹åˆ—ï¼š
  
  - `id`: å•†å“IDï¼ˆå¯¹åº”å›¾åƒæ–‡ä»¶åï¼Œå¦‚ `097585562X.jpg`ï¼‰
  - `title`: å•†å“æ ‡é¢˜
  - `description`: å•†å“æè¿°
  - `categories`: ç±»åˆ«æ ‡ç­¾ï¼ˆ0-20ï¼Œå…±21ç±»ï¼‰
  
- `test.csv` åº”åŒ…å«ä»¥ä¸‹åˆ—ï¼š
  
  - `id`: å•†å“ID
  - `title`: å•†å“æ ‡é¢˜
  - `description`: å•†å“æè¿°
  
  

## ğŸ¤– æ¨¡å‹ä¸‹è½½

### ä¸‹è½½ SigLIP æ¨¡å‹

æœ¬é¡¹ç›®ä½¿ç”¨ `siglip-so400m-patch14-384` æ¨¡å‹ã€‚å°†æ¨¡å‹ä¸‹è½½åˆ° `models/` ç›®å½•ï¼š

```bash
# åˆ›å»ºæ¨¡å‹ç›®å½•
mkdir -p models

# ä¸‹è½½æ¨¡å‹ï¼ˆä½¿ç”¨ huggingface-cliï¼‰
huggingface-cli download google/siglip-so400m-patch14-384 --local-dir models/siglip-so400m-patch14-384
```

æ¨¡å‹ä¸‹è½½åï¼Œç›®å½•ç»“æ„åº”ä¸ºï¼š

```
./models/siglip-so400m-patch14-384
â”œâ”€â”€ config.json
â”œâ”€â”€ model.safetensors
â”œâ”€â”€ preprocessor_config.json
â”œâ”€â”€ README.md
â”œâ”€â”€ special_tokens_map.json
â”œâ”€â”€ spiece.model
â”œâ”€â”€ tokenizer.json
â””â”€â”€ tokenizer_config.json
```



## ğŸš€ è¿è¡ŒæŒ‡å—

### è®­ç»ƒæ¨¡å‹

#### å•å¡è®­ç»ƒ

```bash
python main.py
```
é»˜è®¤é…ç½®ä¸‹éœ€è¦**24Gæ˜¾å­˜**ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è¦†ç›–é»˜è®¤é…ç½®ï¼Œ**å¸¸ç”¨å‚æ•°è¯´æ˜ï¼š**

- `--batch_size`: è®­ç»ƒæ‰¹æ¬¡å¤§å°ï¼ˆé»˜è®¤ï¼š8ï¼‰
- `--eval_batch_size`: éªŒè¯æ‰¹æ¬¡å¤§å°ï¼ˆé»˜è®¤ï¼š16ï¼‰
- `--learning_rate`: å­¦ä¹ ç‡ï¼ˆé»˜è®¤ï¼š2e-5ï¼‰
- `--num_epochs`: è®­ç»ƒè½®æ•°ï¼ˆé»˜è®¤ï¼š5ï¼‰
- `--n_folds`: KæŠ˜äº¤å‰éªŒè¯çš„æŠ˜æ•°ï¼ˆé»˜è®¤ï¼š5ï¼‰
- `--skip_folds`: è·³è¿‡çš„æŠ˜æ•°ï¼ˆé»˜è®¤ï¼š0ï¼Œä»ç¬¬0æŠ˜å¼€å§‹è®­ç»ƒï¼‰
- `--use_fp16`: æ˜¯å¦ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒï¼ˆé»˜è®¤ï¼šTrueï¼‰
- `--use_class_weight`: æ˜¯å¦ä½¿ç”¨ç±»åˆ«æƒé‡ï¼ˆé»˜è®¤ï¼šFalseï¼‰
- `--train_csv`: è®­ç»ƒé›†CSVè·¯å¾„ï¼ˆé»˜è®¤ï¼š`data/train.csv`ï¼‰
- `--test_csv`: æµ‹è¯•é›†CSVè·¯å¾„ï¼ˆé»˜è®¤ï¼š`data/test.csv`ï¼‰
- `--train_images_dir`: è®­ç»ƒå›¾åƒç›®å½•ï¼ˆé»˜è®¤ï¼š`data/train_images/train_images`ï¼‰
- `--test_images_dir`: æµ‹è¯•å›¾åƒç›®å½•ï¼ˆé»˜è®¤ï¼š`data/test_images/test_images`ï¼‰
- `--model_name`: æ¨¡å‹è·¯å¾„ï¼ˆé»˜è®¤ï¼š`./models/siglip-so400m-patch14-384`ï¼‰
- `--results_dir`: ç»“æœä¿å­˜ç›®å½•ï¼ˆé»˜è®¤ï¼š`results/`ï¼‰



### æ¨ç†é¢„æµ‹

è®­ç»ƒå®Œæˆåï¼Œä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹è¿›è¡Œæ¨ç†ï¼š

```bash
python predict.py --checkpoint_dir results/2024-01-01_12-00-00/weights
```

**å‚æ•°è¯´æ˜ï¼š**

- `--checkpoint_dir`: æ¨¡å‹æƒé‡ç›®å½•è·¯å¾„ï¼ˆåŒ…å«æ‰€æœ‰æŠ˜çš„ `best_model_fold*.pth` æ–‡ä»¶ï¼‰
- `--test_csv`: æµ‹è¯•é›†CSVè·¯å¾„
- `--test_images_dir`: æµ‹è¯•å›¾åƒç›®å½•
- `--model_name`: æ¨¡å‹è·¯å¾„

æ¨ç†ç»“æœå°†ä¿å­˜åœ¨ `results/{timestamp}/` ç›®å½•ä¸‹ï¼š

- `submission.csv`: æœ€ç»ˆé¢„æµ‹ç»“æœï¼ˆid, categoriesï¼‰
- `submission_probs.csv`: å„ç±»åˆ«æ¦‚ç‡ï¼ˆid, c0, c1, ..., c20ï¼‰



## ğŸ“ é¡¹ç›®ç»“æ„

```
goods-clas/
â”œâ”€â”€ main.py                 # å•å¡è®­ç»ƒä¸»ç¨‹åº
â”œâ”€â”€ predict.py              # æ¨ç†é¢„æµ‹è„šæœ¬
â”œâ”€â”€ pyproject.toml          # é¡¹ç›®ä¾èµ–é…ç½®
â”œâ”€â”€ uv.lock                 # ä¾èµ–é”å®šæ–‡ä»¶
â”œâ”€â”€ README.md               # æœ¬æ–‡ä»¶
â”œâ”€â”€ data/                   # æ•°æ®ç›®å½•ï¼ˆéœ€è‡ªè¡Œä¸‹è½½ï¼‰
â”‚   â”œâ”€â”€ train.csv
â”‚   â”œâ”€â”€ test.csv
â”‚   â”œâ”€â”€ train_images/
â”‚   â””â”€â”€ test_images/
â”œâ”€â”€ models/                 # æ¨¡å‹ç›®å½•ï¼ˆéœ€è‡ªè¡Œä¸‹è½½ï¼‰
â”‚   â””â”€â”€ siglip-so400m-patch14-384/
â”œâ”€â”€ results/                # è®­ç»ƒç»“æœç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”‚   â””â”€â”€ {timestamp}/
â”‚       â”œâ”€â”€ weights/         # æ¨¡å‹æƒé‡
â”‚       â”‚   â”œâ”€â”€ best_model_fold0.pth
â”‚       â”‚   â”œâ”€â”€ best_model_fold1.pth
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ config.json     # è®­ç»ƒé…ç½®
â”‚       â”œâ”€â”€ submission.csv  # é¢„æµ‹ç»“æœ
â”‚       â””â”€â”€ submission_probs.csv  # é¢„æµ‹æ¦‚ç‡
â”œâ”€â”€ src/                    # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py           # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ dataset.py          # æ•°æ®é›†å®šä¹‰
â”‚   â”œâ”€â”€ model.py            # æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ augment.py          # æ•°æ®å¢å¼º
â”‚   â”œâ”€â”€ loops.py            # è®­ç»ƒ/éªŒè¯/é¢„æµ‹å¾ªç¯
â”‚   â””â”€â”€ utils.py            # å·¥å…·å‡½æ•°
â””â”€â”€ scripts/                # è¾…åŠ©è„šæœ¬
    â”œâ”€â”€ compress.py
    â”œâ”€â”€ compress_api.py
    â”œâ”€â”€ get_text_emb.py
    â”œâ”€â”€ pseudo_label.py
    â””â”€â”€ split.py
```



## âš™ï¸ é…ç½®è¯´æ˜

æ‰€æœ‰é…ç½®å‚æ•°åœ¨ `src/config.py` ä¸­å®šä¹‰ï¼Œæ”¯æŒé€šè¿‡å‘½ä»¤è¡Œå‚æ•°è¦†ç›–ã€‚ä¸»è¦é…ç½®åŒ…æ‹¬ï¼š

### è·¯å¾„é…ç½®

- `train_csv`: è®­ç»ƒé›†CSVæ–‡ä»¶è·¯å¾„
- `test_csv`: æµ‹è¯•é›†CSVæ–‡ä»¶è·¯å¾„
- `train_images_dir`: è®­ç»ƒå›¾åƒç›®å½•
- `test_images_dir`: æµ‹è¯•å›¾åƒç›®å½•
- `model_name`: é¢„è®­ç»ƒæ¨¡å‹è·¯å¾„
- `results_dir`: ç»“æœä¿å­˜ç›®å½•

### æ¨¡å‹é…ç½®

- `num_classes`: åˆ†ç±»ç±»åˆ«æ•°ï¼ˆé»˜è®¤ï¼š21ï¼‰
- `hidden_dim`: èåˆå±‚éšè—ç»´åº¦ï¼ˆé»˜è®¤ï¼š1536ï¼‰
- `dropout`: Dropout æ¯”ç‡ï¼ˆé»˜è®¤ï¼š0.2ï¼‰
- `image_size`: å›¾åƒè¾“å…¥å°ºå¯¸ï¼ˆé»˜è®¤ï¼š384ï¼‰
- `max_text_length`: æ–‡æœ¬æœ€å¤§é•¿åº¦ï¼ˆé»˜è®¤ï¼š64ï¼‰

### è®­ç»ƒé…ç½®

- `batch_size`: è®­ç»ƒæ‰¹æ¬¡å¤§å°
- `eval_batch_size`: éªŒè¯æ‰¹æ¬¡å¤§å°
- `num_epochs`: è®­ç»ƒè½®æ•°
- `learning_rate`: å­¦ä¹ ç‡
- `weight_decay`: æƒé‡è¡°å‡
- `warmup_ratio`: å­¦ä¹ ç‡é¢„çƒ­æ¯”ä¾‹
- `n_folds`: KæŠ˜äº¤å‰éªŒè¯æŠ˜æ•°
- `use_fp16`: æ˜¯å¦ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒ



## ğŸ“Š è®­ç»ƒæµç¨‹

1. **æ•°æ®åŠ è½½**ï¼šè¯»å–è®­ç»ƒå’Œæµ‹è¯•CSVæ–‡ä»¶
2. **KæŠ˜åˆ’åˆ†**ï¼šä½¿ç”¨åˆ†å±‚KæŠ˜äº¤å‰éªŒè¯åˆ’åˆ†æ•°æ®
3. **æ¨¡å‹è®­ç»ƒ**ï¼šå¯¹æ¯ä¸€æŠ˜è¿›è¡Œè®­ç»ƒ
   - åˆ›å»ºæ•°æ®é›†å’Œæ•°æ®åŠ è½½å™¨
   - åˆå§‹åŒ–æ¨¡å‹ã€ä¼˜åŒ–å™¨ã€å­¦ä¹ ç‡è°ƒåº¦å™¨
   - è®­ç»ƒå¾ªç¯ï¼ˆæ”¯æŒæ··åˆç²¾åº¦ï¼‰
   - éªŒè¯å¹¶ä¿å­˜æœ€ä½³æ¨¡å‹
4. **æ¨¡å‹é›†æˆ**ï¼šä½¿ç”¨æ‰€æœ‰æŠ˜çš„æœ€ä½³æ¨¡å‹è¿›è¡Œé›†æˆé¢„æµ‹
5. **ç»“æœä¿å­˜**ï¼šä¿å­˜é¢„æµ‹ç»“æœå’Œæ¦‚ç‡æ–‡ä»¶



## ğŸ” ç›‘æ§å’Œæ—¥å¿—

- **Weights & Biases**: è‡ªåŠ¨è®°å½•è®­ç»ƒæŒ‡æ ‡ã€éªŒè¯æŒ‡æ ‡ã€æ··æ·†çŸ©é˜µç­‰
- **æ§åˆ¶å°è¾“å‡º**: å®æ—¶æ˜¾ç¤ºè®­ç»ƒè¿›åº¦ã€æŸå¤±ã€å‡†ç¡®ç‡ç­‰
- **ç»“æœæ–‡ä»¶**: åœ¨ `results/{timestamp}/` ç›®å½•ä¸‹ä¿å­˜æ‰€æœ‰ç»“æœ

